\section{Consensus layer support} \label{sec.consensus}

\subsection{The interlink pointers data structure}
\label{sec.interlink}

We will now start constructing a concrete blockchain proof protocol. Before
we're able to define the prover and the verifier algorithms, we need to propose
certain modifications to the consensus layer.

Observe that in expectation, half of the blocks will be of level $1$, $1/4$
of the blocks will be of level $2$, $1/8$ will be of level $3$ and $1/2^\mu$
blocks will be of level $\mu$. In expectation, the number of superblock levels
of a chain $\chain$ will be $\log(\chain)$. Figure~\ref{fig.hierarchy}
illustrates the blockchain superblocks starting from level $1$ and going up to
level $4$ in case these blocks are distributed exactly according to expectation.
Here, each level contains half the blocks of the level below.

\begin{figure}
    \caption{The hierarchical blockchain.
    Higher levels have achieved a lower target (higher difficulty) during mining.}
    \centering
    \iftwocolumn
        \includegraphics[width=\columnwidth,keepaspectratio]{figures/hierarchical-ledger.png}
    \else
        \includegraphics[width=0.7\columnwidth,keepaspectratio]{figures/hierarchical-ledger.png}
    \fi
    \label{fig.hierarchy}
\end{figure}

The \textit{interlink} data structure is proposed to be included in each block,
replacing the existing pointer to the previous block with a list of pointers to
a small number of previous blocks. For each block, this data structure contains
a pointer to the most recent preceding block of every level $\mu$. The algorithm
for this construction is shown in Algorithm~\ref{alg.nipopow-interlink} and is
borrowed from \cite{KLS}. Genesis is of infinite level and hence a pointer to it
is included in every block at the first available index within the interlink
data structure. The interlink data structure turns the blockchain into a
skiplist-like data structure.  The number of pointers that need to be included
per block is in expectation $\log(\chain)$.

The updateInterlink algorithm accepts a block $B'$, which already has an
interlink data structure defined on it. The function evaluates the
interlink data structure which needs to be included as part of the next block.
It copies the existing interlink data structure and
then modifies some of its entries from level $0$ to $\textsf{level}(B')$ to
point to the block $B'$.

% \import{./}{algorithms/alg.nipopow-helper.tex}
\import{./}{algorithms/alg.nipopow-interlink.tex}

\subsection{Superchain quality}

We now describe the distribution of superblocks within a blockchain.

\begin{definition}[Locally good superchain]
A superchain $\chain'$ of level
$\mu$ with underlying chain $\chain$ is said to be $\mu$-\textnormal{locally-good}
with respect to security parameter $\delta$, written
$\textsf{local-good}_{\delta}(\chain', \chain, \mu)$, if $|\chain'| > (1 -
\delta)2^{-\mu}|\chain|$.
\end{definition}

\begin{restatable}[Local goodness]{lemma}{restateThmLocalGood}
\label{lem.localgood}
Assume chain $\chain$ contains only honestly-generated blocks and has been
adopted by an honest party in an execution with random network scheduling. Then
for all levels $\mu$, for all constant $\delta > 0$, all continuous subchains
$\chain' = \chain[i:j]$ with $|\chain'| \geq m$ are locally good,
$\textsf{local-good}_{\delta}(\chain', \chain, \mu)$, with overwhelming
probability in $m$.
\end{restatable}
\ifonecolumn
\import{./}{proofs/localgood.tex}
\fi

\begin{definition}[Chain superquality]
The $(\delta, m)$ superquality property
$Q^\mu_{scq}$ of a chain $\chain$ pertaining to level $\mu$ with security
parameters $\delta \in \mathbb{R}$ and $m \in \mathbb{N}$ states that for all
$m' \geq m$, it holds that $\textsf{local-good}_{\delta}(C\upchain^\mu[-m':],
C\upchain^\mu[-m':]\downchain, \mu)$. That is, all suffixes that are
sufficiently large are locally good.
\end{definition}

\begin{restatable}[Superquality]{lemma}{restateThmSuperquality}
\label{lem.superquality}
For all levels $\mu$, for all constant $\delta > 0$, a chain
$\chain$ containing only honestly-generated blocks adopted by an honest party in
an execution with random network scheduling has $(\delta, m)$-superquality at level
$\mu$ with overwhelming probability in $m$.
\end{restatable}
\ifonecolumn
\import{./}{proofs/superquality.tex}
\fi

\begin{definition}[Multilevel quality]
A $\mu$-superchain $\chain'$ is said to have \textit{multilevel quality}, written
$\textnormal{multi-good}_{\delta, k_1}(\chain, \chain', \mu)$ with respect to an
underlying chain $\chain = \chain'\downchain$ with security parameters $k_1,
\delta$ if for all $\mu' < \mu$ it holds that for any $\chain^* \subseteq \chain$,
if $|\chain^*\upchain^{\mu'}| = k_1$, then $|\chain^*\upchain^{\mu}| \geq (1 -
\delta)2^{\mu - \mu'}|\chain^*\upchain^{\mu'}|$
\end{definition}

Note also that for $\delta < 0.5$, multilevel quality implies that
$|\chain^*\upchain^{\mu}| \geq 1$.

\begin{lemma}[Multilevel quality]\label{lem.multilevel}
For all levels $\mu$, for all constant $0 < \delta \leq 0.5$, a chain $\chain$
containing only honestly-generated blocks adopted by an honest party in an
execution with random scheduling has $(\delta, k_1)$ multilevel quality at level
$\mu$ with overwhelming probability in $k_1$.
\end{lemma}
\ifonecolumn
\begin{proof}\textbf{(Sketch)}
This proof is identical to the one of Lemma~\ref{lem.localgood}.
% \dznote{TODO: Write the exact proof for this}
\Qed
\end{proof}
\fi

\begin{definition}[Good superchain]\label{lem.good}
A $\mu$-superchain $\chain'$ is said to be \textit{good}, written
$\textnormal{good}_{\delta, k_1}(\chain, \chain', \mu)$, with respect to an
underlying chain $\chain = \chain'\downchain$ if it has both superquality and multilevel quality with the same parameters $(\delta, m)$.
\end{definition}

\begin{corollary}[Optimistic superchain distribution]
\label{crly.superchain-distribution}
For all levels $\mu$, for all constant $0 < \delta < 0.5$, a chain
$\chain$ containing only honestly-generated blocks adopted by an honest party in
an execution with random scheduling is $(\delta, m)$-good at level
$\mu$ with overwhelming probability in $m$.
\end{corollary}
\ifonecolumn
\begin{proof}
This is a direct consequence of Lemma~\ref{lem.superquality} and
Lemma~\ref{lem.multilevel}. \Qed
\end{proof}
\fi
